import React, { useState } from 'react';
import { Download, Search, AlertCircle, CheckCircle2 } from 'lucide-react';

export default function AuditLogScraper() {
  const [url, setUrl] = useState('https://learn.microsoft.com/en-us/office/office-365-management-api/office-365-management-activity-api-schema#auditlogrecordtype');
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');

  const scrapeData = async () => {
    setLoading(true);
    setError('');
    setSuccess('');
    setData([]);

    try {
      // Fetch the live page content
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 8000,
          messages: [
            {
              role: 'user',
              content: `Please use web_fetch to retrieve the content from this URL: ${url}
              
Then, find ONLY the table with the heading "AuditLogRecordType" and extract all rows from that specific table. 
The table should have three columns: Value, Member name, and Description.

Return the data as a JSON array where each object has:
{
  "value": "the numeric ID",
  "name": "the member name", 
  "description": "the description text"
}

IMPORTANT: Only extract data from the AuditLogRecordType table, ignore all other tables on the page.`
            }
          ],
          tools: [
            {
              type: "web_search_20250305",
              name: "web_search"
            }
          ]
        })
      });

      const result = await response.json();
      
      // Extract text content from Claude's response
      let textContent = '';
      for (const item of result.content) {
        if (item.type === 'text') {
          textContent += item.text;
        }
      }

      // Try to find and parse JSON array in the response
      const jsonMatch = textContent.match(/\[\s*\{[\s\S]*?\}\s*\]/);
      if (jsonMatch) {
        try {
          const parsed = JSON.parse(jsonMatch[0]);
          if (Array.isArray(parsed) && parsed.length > 0) {
            setData(parsed);
            setSuccess(`Successfully extracted ${parsed.length} audit log types from the AuditLogRecordType table!`);
          } else {
            throw new Error('Invalid data format');
          }
        } catch (parseErr) {
          throw new Error('Failed to parse extracted data');
        }
      } else {
        throw new Error('Could not find table data in response');
      }
    } catch (err) {
      console.error('Scraping error:', err);
      setError(`Unable to fetch live data: ${err.message}. Please upload an HTML file or use sample data.`);
    }

    setLoading(false);
  };

  const parseHTML = (html) => {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    
    // Find the AuditLogRecordType section specifically
    let targetTable = null;
    const headings = doc.querySelectorAll('h2, h3, h4');
    
    // Look for the heading that contains "AuditLogRecordType"
    for (let heading of headings) {
      if (heading.textContent.includes('AuditLogRecordType')) {
        // Find the next table after this heading
        let nextElement = heading.nextElementSibling;
        while (nextElement) {
          if (nextElement.tagName === 'TABLE') {
            targetTable = nextElement;
            break;
          }
          nextElement = nextElement.nextElementSibling;
        }
        break;
      }
    }
    
    // If we didn't find it by heading, look for a table with the right structure
    if (!targetTable) {
      const tables = doc.querySelectorAll('table');
      for (let table of tables) {
        const headers = table.querySelectorAll('thead th, thead td');
        const headerText = Array.from(headers).map(h => h.textContent.trim().toLowerCase());
        
        // Check if this table has the expected columns
        if (headerText.includes('value') && 
            (headerText.includes('member name') || headerText.includes('member')) && 
            headerText.includes('description')) {
          targetTable = table;
          break;
        }
      }
    }
    
    if (!targetTable) {
      throw new Error('Could not find AuditLogRecordType table in HTML');
    }
    
    // Extract data from the specific table
    const rows = targetTable.querySelectorAll('tbody tr');
    const extracted = [];
    
    rows.forEach(row => {
      const cells = row.querySelectorAll('td');
      if (cells.length >= 3) {
        const value = cells[0].textContent.trim();
        const name = cells[1].textContent.trim();
        const description = cells[2].textContent.trim();
        
        // Only add if we have valid data (skip empty rows)
        if (value && name && description) {
          extracted.push({ value, name, description });
        }
      }
    });

    if (extracted.length > 0) {
      setData(extracted);
      setSuccess(`Successfully extracted ${extracted.length} audit log types from AuditLogRecordType table!`);
    } else {
      throw new Error('No data rows found in AuditLogRecordType table');
    }
  };

  const loadSampleData = () => {
    const sample = [
      { value: "1", name: "ExchangeAdmin", description: "Events from the Exchange admin audit log." },
      { value: "2", name: "ExchangeItem", description: "Events from an Exchange mailbox audit log for actions performed on a single item." },
      { value: "3", name: "ExchangeItemGroup", description: "Events from an Exchange mailbox audit log for actions performed on multiple items." },
      { value: "4", name: "SharePoint", description: "SharePoint events." },
      { value: "6", name: "SharePointFileOperation", description: "SharePoint file operation events." },
      { value: "8", name: "AzureActiveDirectory", description: "Azure Active Directory events." },
      { value: "9", name: "AzureActiveDirectoryAccountLogon", description: "Azure Active Directory OrgId logon events." },
      { value: "10", name: "DataCenterSecurityCmdlet", description: "Data Center security cmdlet events." },
      { value: "11", name: "ComplianceDLPSharePoint", description: "DLP events in SharePoint and OneDrive for Business." },
      { value: "13", name: "ComplianceDLPExchange", description: "DLP events in Exchange." },
      { value: "14", name: "SharePointSharingOperation", description: "SharePoint sharing events." },
      { value: "15", name: "AzureActiveDirectoryStsLogon", description: "Secure Token Service (STS) logon events in Azure Active Directory." },
      { value: "18", name: "SecurityComplianceCenterEOPCmdlet", description: "Admin actions from the Security & Compliance Center." },
      { value: "20", name: "PowerBIAudit", description: "Power BI events." },
      { value: "21", name: "CRM", description: "Dynamics 365 events." },
      { value: "22", name: "Yammer", description: "Yammer events." },
      { value: "23", name: "SkypeForBusinessCmdlets", description: "Skype for Business events." },
      { value: "24", name: "Discovery", description: "eDiscovery events." },
      { value: "25", name: "MicrosoftTeams", description: "Microsoft Teams events." },
      { value: "28", name: "ThreatIntelligence", description: "Phishing and malware events from Exchange Online Protection and Microsoft Defender for Office 365." },
      { value: "30", name: "MailSubmission", description: "Email submission events from Exchange Online Protection and Microsoft Defender for Office 365." },
      { value: "32", name: "MicrosoftFlow", description: "Microsoft Power Automate events." },
      { value: "33", name: "AeD", description: "Advanced eDiscovery events." },
      { value: "35", name: "MicrosoftStream", description: "Microsoft Stream events." },
      { value: "36", name: "ThreatFinder", description: "Campaign-related events from Microsoft Defender for Office 365." },
      { value: "38", name: "Project", description: "Microsoft Project events." },
      { value: "40", name: "SecurityComplianceAlerts", description: "Security and compliance alert signals." },
      { value: "41", name: "ThreatIntelligenceUrl", description: "Safe links time-of-block and block override events." },
      { value: "44", name: "SecurityComplianceInsights", description: "Security and compliance insights and reports." },
      { value: "45", name: "MIPLabel", description: "Events for detection of email tagged with sensitivity labels." },
      { value: "47", name: "WorkplaceAnalytics", description: "Workplace Analytics events." },
      { value: "52", name: "AirInvestigation", description: "Automated incident response (AIR) events." }
    ];
    setData(sample);
    setSuccess('Loaded sample data. Upload your own HTML file for complete data.');
  };

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          parseHTML(event.target.result);
        } catch (err) {
          setError('Failed to parse HTML file. Please ensure it contains the AuditLogRecordType table.');
        }
      };
      reader.readAsText(file);
    }
  };

  const generateElasticMapping = () => {
    return JSON.stringify({
      mappings: {
        properties: {
          "audit_log_type": { "type": "keyword" },
          "audit_log_type_id": { "type": "integer" },
          "audit_log_description": { "type": "text" }
        }
      }
    }, null, 2);
  };

  const generateSplunkLookup = () => {
    let csv = 'audit_log_type_id,audit_log_type,audit_log_description\n';
    data.forEach(item => {
      csv += `${item.value},"${item.name}","${item.description.replace(/"/g, '""')}"\n`;
    });
    return csv;
  };

  const generateLogstashFilter = () => {
    let filter = 'filter {\n  translate {\n    field => "RecordType"\n    destination => "audit_log_type"\n    dictionary => {\n';
    data.forEach(item => {
      filter += `      "${item.value}" => "${item.name}"\n`;
    });
    filter += '    }\n    fallback => "Unknown"\n  }\n}';
    return filter;
  };

  const downloadFile = (content, filename, type) => {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 p-6">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl p-8 border border-white/20">
          <h1 className="text-4xl font-bold text-white mb-2">
            Microsoft Audit Log Type Reference Generator
          </h1>
          <p className="text-blue-200 mb-8">
            Extract AuditLogRecordType data and generate SIEM lookup files for Elastic and Splunk
          </p>

          {/* Input Section */}
          <div className="bg-white/5 rounded-xl p-6 mb-6 border border-white/10">
            <h2 className="text-xl font-semibold text-white mb-4">Data Source</h2>
            
            <div className="mb-4">
              <label className="block text-sm font-medium text-blue-200 mb-2">
                Microsoft Documentation URL
              </label>
              <input
                type="text"
                value={url}
                onChange={(e) => setUrl(e.target.value)}
                className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>

            <div className="flex gap-4 mb-4">
              <button
                onClick={scrapeData}
                disabled={loading}
                className="flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded-lg font-medium transition-colors"
              >
                <Search size={20} />
                {loading ? 'Fetching...' : 'Fetch Data'}
              </button>

              <label className="flex items-center gap-2 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium cursor-pointer transition-colors">
                <Download size={20} />
                Upload HTML File
                <input
                  type="file"
                  accept=".html"
                  onChange={handleFileUpload}
                  className="hidden"
                />
              </label>

              <button
                onClick={loadSampleData}
                className="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors"
              >
                Load Sample Data
              </button>
            </div>

            {error && (
              <div className="flex items-start gap-2 p-4 bg-red-500/20 border border-red-500/50 rounded-lg text-red-200">
                <AlertCircle size={20} className="mt-0.5 flex-shrink-0" />
                <span>{error}</span>
              </div>
            )}

            {success && (
              <div className="flex items-start gap-2 p-4 bg-green-500/20 border border-green-500/50 rounded-lg text-green-200">
                <CheckCircle2 size={20} className="mt-0.5 flex-shrink-0" />
                <span>{success}</span>
              </div>
            )}
          </div>

          {/* Data Table */}
          {data.length > 0 && (
            <>
              <div className="bg-white/5 rounded-xl p-6 mb-6 border border-white/10">
                <h2 className="text-xl font-semibold text-white mb-4">
                  Extracted Data ({data.length} entries)
                </h2>
                <div className="overflow-x-auto max-h-96 overflow-y-auto">
                  <table className="w-full text-left text-sm">
                    <thead className="sticky top-0 bg-slate-800 text-blue-200">
                      <tr>
                        <th className="px-4 py-3 font-semibold">Value</th>
                        <th className="px-4 py-3 font-semibold">Member Name</th>
                        <th className="px-4 py-3 font-semibold">Description</th>
                      </tr>
                    </thead>
                    <tbody className="text-gray-300">
                      {data.map((item, idx) => (
                        <tr key={idx} className="border-t border-white/10 hover:bg-white/5">
                          <td className="px-4 py-3 font-mono">{item.value}</td>
                          <td className="px-4 py-3 font-medium">{item.name}</td>
                          <td className="px-4 py-3">{item.description}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Export Options */}
              <div className="bg-white/5 rounded-xl p-6 border border-white/10">
                <h2 className="text-xl font-semibold text-white mb-4">
                  Export for SIEM
                </h2>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <button
                    onClick={() => downloadFile(generateSplunkLookup(), 'audit_log_types.csv', 'text/csv')}
                    className="p-4 bg-gradient-to-br from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white rounded-lg font-medium transition-all"
                  >
                    <Download size={20} className="inline mr-2" />
                    Splunk Lookup CSV
                  </button>

                  <button
                    onClick={() => downloadFile(generateElasticMapping(), 'elastic_mapping.json', 'application/json')}
                    className="p-4 bg-gradient-to-br from-yellow-600 to-yellow-700 hover:from-yellow-700 hover:to-yellow-800 text-white rounded-lg font-medium transition-all"
                  >
                    <Download size={20} className="inline mr-2" />
                    Elastic Mapping JSON
                  </button>

                  <button
                    onClick={() => downloadFile(generateLogstashFilter(), 'logstash_filter.conf', 'text/plain')}
                    className="p-4 bg-gradient-to-br from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white rounded-lg font-medium transition-all"
                  >
                    <Download size={20} className="inline mr-2" />
                    Logstash Filter
                  </button>

                  <button
                    onClick={() => downloadFile(JSON.stringify(data, null, 2), 'audit_log_types.json', 'application/json')}
                    className="p-4 bg-gradient-to-br from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-lg font-medium transition-all"
                  >
                    <Download size={20} className="inline mr-2" />
                    Raw JSON
                  </button>

                  <button
                    onClick={() => downloadFile(generateSplunkLookup(), 'audit_log_types_elastic.csv', 'text/csv')}
                    className="p-4 bg-gradient-to-br from-cyan-600 to-cyan-700 hover:from-cyan-700 hover:to-cyan-800 text-white rounded-lg font-medium transition-all"
                  >
                    <Download size={20} className="inline mr-2" />
                    Elastic Enrichment CSV
                  </button>
                </div>

                <div className="mt-6 p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                  <h3 className="font-semibold text-blue-200 mb-2">Usage Instructions:</h3>
                  <ul className="text-sm text-blue-200 space-y-1 list-disc list-inside">
                    <li><strong>Splunk:</strong> Upload CSV to lookups directory, configure in transforms.conf</li>
                    <li><strong>Elastic:</strong> Use mapping JSON for index template, CSV for enrichment processor</li>
                    <li><strong>Logstash:</strong> Add filter configuration to your pipeline</li>
                  </ul>
                </div>
              </div>
            </>
          )}
        </div>
      </div>
    </div>
  );
}